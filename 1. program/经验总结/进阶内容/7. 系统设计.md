
# 系统设计

## 一、微服务设计

### 1.1、微服务的核心思想
- 独立性：
  - 各个服务可以独立部署，不依赖其他服务的模块
- 单一职责
  - 只做某一模块的事情
- 轻量级通信
  - 远程调用rpc，快速通信，负载均衡
- 隔离性
  - 保证每个服务有自己独立的数据源，其他服务只能通过接口调用的形式来操作其他服务的数据源

### 1.2、eureka服务注册发现
- __服务注册__
  - 服务启动后注册到eureka当中，eureka维护一个服务注册表，

- __服务下线__
  - x

- __服务状态更新__
  - 每个服务默认30秒发送一个心跳包来保证自己在eureka中的连接状态
- __故障发现__
  - eureka默认每隔60秒把服务注册表中超时续约（默认90秒）的服务剔除出去
![](https://gitee.com/jingxuanye/yjx-pictures/raw/master/pic/20200702211216.png)

- __自我保护__

- __eureka高可用__
  - 主从模式
    ![](https://gitee.com/jingxuanye/yjx-pictures/raw/master/pic/20200704102634.png)
  - 自研集群模式
    ![](https://gitee.com/jingxuanye/yjx-pictures/raw/master/pic/20200704103108.png)
    - eureka的集群部署，每个eureka单机保存部分的服务注册表，服务只拉取自己需要的服务注册表

  - zk的反向通知机制其实不太适合做大规模高并发的服务注册机制，服务频繁的上下线，会造成瞬时大量的请求，导致网卡奔溃

### 1.3、hystrix服务容错保护

- hystrix的两种模式
  - 线程池隔离模式：
    - 使用一个线程池来存储当前的请求，线程池对请求作处理，设置任务返回处理超时时间，堆积的请求堆积入线程池队列。这种方式需要为每个依赖的服务申请线程池，有一定的资源消耗，好处是可以应对突发流量（流量洪峰来临时，处理不完可将数据存储到线程池队里慢慢处理）。
  - 信号量隔离模式
    - 使用一个原子计数器（或信号量）来记录当前有多少个线程在运行，请求来先判断计数器的数值，若超过设置的最大线程个数则丢弃改类型的新请求，若不超过则执行计数操作请求来计数器+1，请求返回计数器-1。这种方式是严格的控制线程且立即返回模式，无法应对突发流量（流量洪峰来临时，处理的线程超过数量，其他的请求会直接返回，不继续去请求依赖的服务）

    ![](https://gitee.com/jingxuanye/yjx-pictures/raw/master/pic/20200704194326.png)

- 限流
  - Hystrix 通过判断线程池或者信号量是否已满，超出容量的请求，直接 Reject 走降级，从而达到限流的作用。
- 降级
- 熔断


### 1.4、ribbon、feign远程服务调用和负载均衡
- __调用流程__
  - 注册成功的服务会每隔30秒（可配置）从eureka中拉取服务注册表，ribbon/feign调用其他服务的时候，会根据服务注册表里的相关服务进行请求访问，
- __负载均衡__
  - 默认采用轮询的方法进行负载均衡，当然也可以实现自己定义的负载均衡器
  - RandomRule:随机  RoundRobinRule:线性轮询方式  WeightedResponseTimeRule:权重
  - 
- __容错机制__
  - 如果服务A有1、2、3三个节点，服务B调用服务A的时候，可以设置调用的超时时间、重试次数、以及超时重试失败后是否调用其他节点的服务。__也可以在zuul中进行配置。__


### 1.5、zuul && gateway网关服务

- __基于zuul实现灰度发布__

### 1.6、springcloud-config

### 1.7、sleuth、zipkin分布式服务追踪


### 1.8、接口幂等性
- __数据库唯一索引__
- __基于redis实现一套幂等性防重框架__


### 1.8、系统发布
- __蓝绿部署__
  - 绿部署，是指同时运行两个版本的应用，部署的时候，并不停止掉老版本，直接部署一套新版本，等新版本运行起来后，再将流量切换到新版本上。
  - 蓝绿部署要求在升级过程中，同时运行两套程序，对硬件的要求就是日常所需的二倍，比如日常运行时，需要10台服务器支撑业务，那么使用蓝绿部署，你就需要购置二十台服务器。

- __滚动发布__
  - 滚动升级，就是在升级过程中，并不一下子启动所有新版本，是先启动一台新版本，再停止一台老版本，然后再启动一台新版本，再停止一台老版本，直到升级完成，这样的话，如果日常需要10台服务器，那么升级过程中也就只需要11台就行了
  - 开始滚动升级后，流量会直接流向已经启动起来的新版本，但是这个时候，新版本是不一定可用的，比如需要进一步的测试才能确认。那么在滚动升级期间，整个系统就处于非常不稳定的状态，如果发现了问题，也比较难以确定是新版本还是老版本造成的问题。

  - 为了解决这个问题，我们需要为滚动升级实现流量控制能力


- __灰度发布__
  - 灰度发布也叫金丝雀发布，起源是，矿井工人发现，金丝雀对瓦斯气体很敏感，矿工会在下井之前，先放一只金丝雀到井中，如果金丝雀不叫了，就代表瓦斯浓度高
  - 灰度发布开始后，先启动一个新版本应用，但是并不直接将流量切过来，而是测试人员对新版本进行线上测试，启动的这个新版本应用，就是我们的金丝雀。如果没有问题，那么可以将少量的用户流量导入到新版本上，然后再对新版本做运行状态观察，收集各种运行时数据，如果此时对新旧版本做各种数据对比，就是所谓的A/B测试
  - 当确认新版本运行良好后，再逐步将更多的流量导入到新版本上，在此期间，还可以不断地调整新旧两个版本的运行的服务器副本数量，以使得新版本能够承受越来越大的流量压力。直到将100%的流量都切换到新版本上，最后关闭剩下的老版本服务，完成灰度发布
  - 如果在灰度发布过程中（灰度期）发现了新版本有问题，就应该立即将流量切回老版本上，这样，就会将负面影响控制在最小范围内。

### 1.9、生成环境的部署
- 中小型的系统，折分为10 - 20个微服务，大的互联网公司，都有几百个、几干个、几万个服务，2-3台机器就足够了，把服务的上、故障以及发现优化到极致

- 服务上线，注册表同步1秒，注册表拉取频率为1秒务心跳，1秒上报1次
故障发现，1秒中检一次1心跳，如果发现2秒内服务没上报心跳，认为故障了

- 服务注册中心部署个2台机器，毎台机器数是4核8G,任何一台机器死掉，不会影响系统的运行，轻松抗下每秒钟上百的请求，

- 系统的QPS在1000左右，2台四核八G的机器完成可以抗住。

- 网关系统，4核8G的机器，一台机器抗每秒几百请求，部器34台机器，保证可以网关统每台机器的压力比较小，进一步保证网关系统可靠性


- 数据库，MYSQL,16核32G,物理机最佳，32核64G,最多抗个每秒钟几千请求问题不大，平时抗个每秒钟几十或者几百请求，三四千请求，但是只不过此时会导致MsQL机器的负载很高，CUP使用率很高，磁盘IO很高，网络负载很高



## 二、中台思想

### 2.1、技术中台

### 2.2、数据中台

### 2.3、业务中台


## 三、领域驱动设计（Domain Driven Design）


## 四、跨区域数据级联同步

### 1、业务背景
- 解决安防业务中，在应用独立部署的情景下，数据需要上行汇总，下行分发的问题。

### 2、技术选型 && 项目架构
- 选用kafka作为消息组件，进行业务数据的分发，和汇总。
  - kafka是天然的分布式消息组件，支持高并发、高可用、集群横向扩展，不受单机性能限制。
  - 进行服务直接的解耦，解决依赖调用关系
  - 解决下级节点多机部署的情景下，数据的分发，问题，

- 选用zk作为分布式协调服务中间件，进行下级应用向上级应用的注册，验活，报警通知等。

- 通过网闸设备，解决GAW和SPW网络不同的问题，在网闸侧建立kafka，通过kafkaStream从一个kafka集群的topic消费数据然后发送到另一个kafka集群的topic里面

### 3、项目设计
- __同步机制__
  - 为需要同步的业务数据创建相关的kafak-topic， 同一类型的topic包含上级节点，和下级节点，各级节点监听自己的topic进而处理相关业务数据。
- __业务数据的顺序执行（topic消息的顺序执行）__
  - 把消息的主键作为key值，同一消息的处理kafka会路由到同一broker中，进行实现对同一数据的操作的顺序执行。

- __kafka丢数据处理__
  - 执行手动的ack处理。

- __消息重复消费__
  - 进行简单幂等性校验处理

- __节点宕机后的失败重试__
  - 保证数据的最终一致性，失败重试到一定次数后，数据保存入本地消息表中，再定时进行消息补偿。

- __节点注册和掉线告警__
  - 次级服务在zk中创建临时节点，上级服务监听该节点，如果下级服务掉线后收到通知，进行告警处理



## 五、源码解读
### 1、redisson
![](https://gitee.com/jingxuanye/yjx-pictures/raw/master/pic/20200704194124.png)

![](https://gitee.com/jingxuanye/yjx-pictures/raw/master/pic/20200704194411.png)

![](https://gitee.com/jingxuanye/yjx-pictures/raw/master/pic/20200704194554.png)

### 2、sentinel(森ten闹)
- Sentinel 是阿里中间件团队开源的，面向分布式服务架构的轻量级高可用流量控制组件，主要以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度来帮助用户保护服务的稳定性。


### 3、macrozheng/mall




## 参考文章

- [100并发 -> 千万并发，阿里淘宝的 14 次架构演进之路！](https://juejin.im/post/5d03ae395188252c023fafea)
- [一个微服务+DDD(领域驱动设计)的代码结构示例](https://blog.csdn.net/weixin_30347009/article/details/95899528?utm_medium=distribute.pc_relevant_t0.none-task-blog-BlogCommendFromMachineLearnPai2-1.nonecase&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-BlogCommendFromMachineLearnPai2-1.nonecase)
  - [项目源码](https://github.com/EalenXie/springcloud-microservice-ddd)
- [Spring Cloud原理详解](https://blog.csdn.net/qq_41701956/article/details/83829539)
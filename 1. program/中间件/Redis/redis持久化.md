
- [一、持久化过程](#%e4%b8%80%e6%8c%81%e4%b9%85%e5%8c%96%e8%bf%87%e7%a8%8b)
- [二、redis的持久化机制](#%e4%ba%8credis%e7%9a%84%e6%8c%81%e4%b9%85%e5%8c%96%e6%9c%ba%e5%88%b6)
  - [2.1、RDB方式（Redis DataBase）](#21rdb%e6%96%b9%e5%bc%8fredis-database)
    - [RDB的触发方式](#rdb%e7%9a%84%e8%a7%a6%e5%8f%91%e6%96%b9%e5%bc%8f)
    - [RDB的优点](#rdb%e7%9a%84%e4%bc%98%e7%82%b9)
    - [RDB的缺点](#rdb%e7%9a%84%e7%bc%ba%e7%82%b9)
  - [2.2 AOF方式（Append Only File）](#22-aof%e6%96%b9%e5%bc%8fappend-only-file)

由于Redis是一种内存型数据库，即服务器在运行时，系统为其分配了一部分内存存储数据，一旦服务器挂了，或者突然宕机了，那么数据库里面的数据将会丢失，为了使服务器即使突然关机也能保存数据，必须通过持久化的方式将数据从内存保存到磁盘中。

### 一、持久化过程

既然redis的数据可以保存在磁盘上，那么这个流程是什么样的呢？

要有下面五个过程：
（1）客户端向服务端发送写操作(数据在客户端的内存中)。
（2）数据库服务端接收到写请求的数据(数据在服务端的内存中)。
（3）服务端调用write这个系统调用，将数据往磁盘上写(数据在系统内存的缓冲区中)。
（4）操作系统将缓冲区中的数据转移到磁盘控制器上(数据在磁盘缓存中)。
（5）磁盘控制器将数据写到磁盘的物理介质中(数据真正落到磁盘上)。

### 二、redis的持久化机制

#### 2.1、RDB方式（Redis DataBase）

RDB持久化是把当前进程数据生成快照保存到硬盘的过程，触发RDB持久化过程分为手动触发和自动触发
##### RDB的触发方式
1. 手动触发：
   - save命令：阻塞当前Redis服务器，直到RDB过程完成为止，对于内存 比较大的实例会造成长时间阻塞，线上环境不建议使用

   - bgsave命令：Redis进程执行fork操作创建子进程，RDB持久化过程由子 进程负责，完成后自动结束。阻塞只发生在fork阶段，一般时间很短

2. 自动触发：
   - 在redis.conf中进行配置 save 10 1



##### RDB的优点
- RDB是一个紧凑压缩的二进制文件，代表Redis在某个时间点上的数据 快照。非常适用于备份，全量复制等场景。比如每6小时执行bgsave备份， 并把RDB文件拷贝到远程机器或者文件系统中（如hdfs），用于灾难恢复。

- 生成RDB文件的时候，redis主进程会fork()一个子进程来处理所有保存工作，主进程不需要进行任何磁盘IO操作。

- Redis加载RDB恢复数据远远快于AOF的方式。

##### RDB的缺点
- RDB方式数据没办法做到实时持久化/秒级持久化。因为bgsave每次运 行都要执行fork操作创建子进程，属于重量级操作，频繁执行成本过高。

- RDB文件使用特定二进制格式保存，Redis版本演进过程中有多个格式 的RDB版本，存在老版本Redis服务无法兼容新版RDB格式的问题。

针对RDB不适合实时持久化的问题，Redis提供了AOF持久化方式来解决。


#### 2.2 AOF方式（Append Only File）

以独立日志的方式记录每次写命令， 重启时再重新执行AOF文件中的命令达到恢复数据的目的。AOF的主要作用 是解决了数据持久化的实时性，目前已经是Redis持久化的主流方式。

